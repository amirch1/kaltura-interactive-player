<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Kaltura Interactive Player </title>
</head>
<body>
<!-- relevant for development only! -->
<!--<script src="http://cdnapisec.kaltura.com/p/27017/embedPlaykitJs/uiconf_id/43398051"></script>-->
<!--<script src="https://qa-apache-php7.dev.kaltura.com/p/6222/embedPlaykitJs/uiconf_id/15219305"></script>-->
<script src="./scripts/localJs.js"></script>
<script src="dist/path-kaltura-player.js" type="text/javascript"></script>
<script src="http://localhost:35729/livereload.js"></script>
<!-- end of relevant for development only! -->
<!-- 350 x 197 / 260 x 146 / 500 x 281 / 150 x 84 ⬇ ︎-->
<style>
    #player {
        width:500px;
        height:281px;
    }
</style>
<h3>test.template.html</h3>
<h4 id="projDetails"></h4>
<div id="player"></div>
<div id="logDiv" style="width: 450px;height: 100%;position: absolute;left:650px;top:0"></div>
<script>

	var optionalPlaylists = [
		{
			name: "short" ,
			id: "1_91tbi9q8" ,
		},
		{
			name: "Multi Audio" ,
			id: "1_q94de4ui" ,
		},
		{
			name: "CL1" ,
			id: "0_ugurmytu" ,
		},
		{
			name: "CL2" ,
			id: "0_5huki1y3" ,
		},
		{
			name: "Animals" ,
			id: "1_60y5a49y" ,
		},
		{
			name: "Complex" ,
			id: "1_51tet0hy",
		},
		{
			name: "Empty" ,
			id: "1_sxcxb5e2",
		} ,
		{
			name: "Start 2 Start" ,
			id: "1_guuku0l9",
		} ,
		{
			name: "1 to 2,3,4" ,
			id: "1_4sjm8veb",
			selected: true
		} ,
		{
			name: "Same-node" ,
			id: "1_4weuna20",
		} ,
		{
			name: "defaultPath" ,
			id: "1_r33krd2s",
		} ,
		{
			name: "self-loop" ,
			id: "1_s0d8kump",
		} ,
		{
			name: "split same" ,
			id: "1_a2m8w1pi",
		} ,
	];

	var selectedItem = optionalPlaylists.find(item => item.selected === true);
	document.getElementById("projDetails").textContent = selectedItem.name + " - " + selectedItem.id;

	var config = {
		targetId: 'player',
		playback:{
			autoplay:true,
			preload:"auto"
		},

		provider: {
			ks : "MmFkM2JiOGFlODQzOWM5NTI2YWYzNWJlOTVkNGQzNWI5YzIxYzY4YXwyNzAxNzsyNzAxNzsxNTQyMjA4MjYwOzI7Mjc4NztfX0FETUlOX18yNjY4NzsqLGRpc2FibGVlbnRpdGxlbWVudA==",
			partnerId: 27017 // 2413351 - balconet 0_dl86knxb
		},

		rapt:{
			debug:true,
			bufferNextNodes: true,
			bufferTime: 3
		}

	};

	var kip = PathKalturaPlayer.setup(config);
	kip.loadMedia({playlistId: selectedItem.id});
	var bufferingEvents = ["buffering","destroying","destroyed","doneBuffering","allBuffered","catchup","allUnbuffered"];
	var apiEvents = [
		"browser:hidden",
		"browser:open",
		"cue:forward",
		"cue:reverse",
		"hotspot:click",
		"node:enter",
		"node:ended",
		"node:exit",
		"project:load",
		"project:ready",
		"project:start",
		"project:unload",
		"project:ended",
		"player:play",
		"player:pause",
		"player:progress",
		"player:ratechange",
		"player:timeupdate",
		"player:volumechange"
	];

	var allEvents;
	// allEvents  = bufferingEvents ;
	// allEvents = apiEvents;
	allEvents = apiEvents.concat(bufferingEvents);

	for (var i = 0 ; i< allEvents.length; i++){
		kip.addListener(allEvents[i] , function (event) {
			logDebugMsg(event);
		});
	}

	// Legacy API example
	kip.kBind('raptMedia_event', function(data) {
		// console.log(">>>>> raptMedia_event",data);
	});

	// logger - debug mode !
	function logDebugMsg(event){
		const oneLine = document.createElement("div");
		// mark buffering event in green
		var printStr = event.type;
		var payload = event.payload;
		if( bufferingEvents.some( a => a ===event.type) ){
			// this is a buffering event
			oneLine.style.cssText = "color: green";
			switch (event.type) {
				case "allBuffered":
					printStr+='<span style="color: purple"> ['+payload+'] ✿ ✿ ✿</span>';
					break;
				case "catchup":
					debugger;
					printStr+='<span style="color: #227a15"> ['+payload.toString()+'] ➥</span>';
					break;
				case "buffering":
					printStr+='<span style="color: #4398a8"> ['+payload+'] ⬇︎ </span>';
					break;
				case "doneBuffering":
					printStr+='<span style="color: brown"> ['+payload+'] ✔︎︎</span>';
					break;
				default:
					printStr+='<span style="color: #c78f35"> ['+payload+']</span>' ;

			}
		}else{
			oneLine.style.cssText = "color: blue";
			switch (event.type) {
				case "player:timeupdate":
					return; // we do not want to print this - it junks the log
				case "cue:forward":
				case "cue:revere":
					printStr+='<span style="color: darkcyan"> ['+payload.cue.customData+']</span>' ;
					break;
				case "hotspot:click":
					printStr+='<span style="color: darkcyan"> ['+payload.hotspot.name+']</span>' ;
					break;
				case "node:enter":
				case "node:ended":
				case "node:exit":
					printStr+='<span style="color: darkcyan"> ['+payload.node.name+']</span>' ;
					break;
				case "player:progress":
					printStr+='<span style="color: darkcyan"> ['+payload.progress+']</span>' ;
					break;
				case "browser:open":
					printStr+='<span style="color: darkcyan"> ['+payload.href+']</span>' ;
					break;
				default:
					if(!isEmpty(payload)){
						printStr+='<span style="color: #9f4e8e"> ['+payload.toString()+']</span>' ;
					}

			}
			// this is a Rapt event
		}
		oneLine.innerHTML = printStr;
		document.getElementById("logDiv").appendChild(oneLine);
	}

	var playKip = function(){
		kip.play();
	}
	function pauseKip(){
		kip.pause();
	}
	function replayKip(){
		kip.replay();
	}
	function resetKip(){
		kip.reset();
	}
	function jumpToNodeKip(o){
		kip.jump(o);
	}
	function seekKip(n){
		kip.seek(n)
	}
	function getNodes() {
		console.table(kip.data.nodes);
	}
	function getMetadata(){
		console.table(kip.metadata.account);
	}
	function currentTime(){
		console.log(kip.currentTime);
	}
	function duration(){
		console.log(kip.duration);
	}
	function currentNode(){
		console.log(kip.currentNode);
	}
	function currentVolume(){
		console.log(kip.volume); // player bug - initial value ?
	}
	function setVolume(n){
		kip.volume = n;
	}
	function muted(){
		console.log(kip.muted); // player bug
	}
	function playbackRate(){
		console.log(kip.playbackRate); // player bug
	}

	// helpers
	function isEmpty(obj) {
		for(var key in obj) {
			if(obj.hasOwnProperty(key))
				return false;
		}
		return true;
	}

	function evaluateKip(key){
		var output = kip.evaluate(key);
		console.log("Evaluated :",key);
		console.log(output);
    }

</script>
<br/>
<div>
    <button onclick="playKip()">play</button>
    <button onclick="pauseKip()">pause</button>
    <button onclick="replayKip()">replay</button>
    <button onclick="resetKip()">reset</button>
    <button onclick="seekKip(5)">Seek to 5</button>
    <button onclick="seekKip(15)">Seek to 15</button>
    <button onclick="seekKip(kip.duration-3)" style="background: #f4cd98">Seek to -3sec</button>
    <button onclick="seekKip(kip.duration-7)" style="background: #f4Fd98">Seek to -7sec</button>
    <br/>
    <br/>
    <button onclick="kip.sendNotification('raptMedia_doCommand',{type:'player:play'})" style="background: #f4cd55">play</button>
    <button onclick="kip.sendNotification('raptMedia_doCommand',{type:'player:pause'})" style="background: #f4cd55">pause</button>
    <button onclick="kip.sendNotification('raptMedia_doCommand',{type:'project:reset'})" style="background: #f4cd55">replay</button>
    <button onclick="kip.execute({type:'project:reset'})" style="background: #f4cd55">replay1</button>
    <button onclick="kip.sendNotification('raptMedia_doCommand',{type: 'player:seek', payload: { time: 5 } })" style="background: #f4cd55">Seek to 5</button>
    <br/>
    <br/>
    <br/>
    <button onclick="jumpToNodeKip({name:'Start'})">JumpToNode {name:'Start'}</button>
    <button onclick="jumpToNodeKip({id:'7354fd9b-6401-4c10-b261-99b4d183d07e'})">JumpToNode {id:'7354fd9b-6401-4c10-b261-99b4d183d07e'}</button>
    <button onclick="jumpToNodeKip({ref:'1_4f9mue48'})">JumpToNode {ref:'1_4f9mue48'}</button>
    <!--<button onclick="jumpToNodeKip({ref:'1_4f9mue48'})">JumpToNode {xref:'1_4f9mue48'}</button>-->
    <br/>
    <br/>
    <button onclick="getNodes()">player.data.nodes</button>
    <button onclick="getMetadata()">player.metadata.account</button>
    <br/>
    <br/>
    <button onclick="evaluateKip('nodes')" style="background: #f4Fd98" >player.data.nodes</button>
    <button onclick="evaluateKip('raptMedia.account')" style="background: #f4Fd98" >raptMedia.account</button>
    <button onclick="evaluateKip('account')" style="background: #f4Fd98" >account</button>
    <button onclick="evaluateKip('{raptMedia.info}')" style="background: #f4Fd98" >{raptMedia.info}</button>
    <button onclick="getMetadata()">player.metadata.account</button>
    <br/>
    <br/>
    <button onclick="currentTime()">player.currentTime</button>
    <button onclick="duration()">player.duration</button>
    <button onclick="currentNode()">player.currentNode</button>
    <button onclick="currentNode()">player.currentNode</button>
    <br>
    <br>
    <button onclick="currentVolume()">player.volume</button>
    <button onclick="setVolume(0.5)">player.volume = 0.5</button>
    <button onclick="setVolume(1)">player.volume = 1</button>
    <button onclick="setVolume(0)">player.volume = 0</button>
    <button onclick="muted()">player.muted</button>

    <br>
    <button onclick="playbackRate()">player.playbackRate</button>
</div>
</body>
</html>
